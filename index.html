<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pagos</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="icons/pagos-icon-192.png">
<meta name="theme-color" content="#7c5cff">
<style>
  body{margin:0;padding:20px;font-family:system-ui;background:#0f1115;color:#e6e8f0;font-size:18px;}
  h1{text-align:center;margin:16px 0;}
  .card{background:#171923;padding:20px;border-radius:12px;margin-bottom:20px;min-height:300px;display:flex;flex-direction:column;justify-content:space-between;transition:transform 0.3s ease-in-out;}
  .card h2{text-align:center;margin-bottom:10px;font-size:22px;}
  .card .income{font-size:18px;margin-top:5px;display:block;}
  .row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #2a2f3a;}
  .row:last-child{border-bottom:none;}
  .row .bill-name{font-weight:bold;}
  .toggle{appearance:none;width:50px;height:26px;border-radius:26px;position:relative;background:#252a36;border:1px solid #394055;cursor:pointer;transition:.2s;}
  .toggle::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#8a93a8;transition:.2s;}
  .toggle:checked{background:linear-gradient(90deg,#1db954,#22d06e);border-color:#179d4d;}
  .toggle:checked::after{left:23px;background:white;}
  .progress{height:10px;background:#242938;border-radius:8px;overflow:hidden;margin-top:10px;border:1px solid #32384e;}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,#7c5cff,#22d06e);width:0%;}
  .summary{margin-top:16px;padding:16px;background:#171923;border-radius:10px;font-size:18px;text-align:center;}
  .month-summary{margin-top:10px;padding:12px;border-radius:10px;font-size:16px; transition: background-color 0.5s ease;}
  .month-summary.all-paid{background-color: #179d4d; color: white;}
  .month-summary h3{margin-top:0;font-size:18px;text-align:center;}
  .bill-item{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid #2a2f3a;}
  .bill-item:last-child{border-bottom:none;}
  .bill-item .paid-amount{color: #1db954;}
  .navigation-buttons{display:none;}
</style>
</head>
<body>
<h1>Pagos V1.0</h1>
<section id="weekContainer"></section>
<div class="navigation-buttons">
  <button id="prevWeek">Previous</button>
  <button id="nextWeek">Next</button>
</div>
<div class="summary" id="allSummary"></div>
<div class="month-summary" id="monthSummary"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC7ubmyUmeCAun50g-AUUOHiuwpGAys2HM",
  authDomain: "budget-tracker-1eea7.firebaseapp.com",
  projectId: "budget-tracker-1eea7",
  storageBucket: "budget-tracker-1eea7.firebasestorage.app",
  messagingSenderId: "579597071031",
  appId: "1:579597071031:web:f30c2d42cc57268707d332"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const TOGGLE_DOC = doc(db,"toggles","weeklyState");
let state = {};

// --- HELPER FOR ARIZONA TIME ---
function parseAZDate(str){
  const [y,m,d]=str.split('-').map(Number);
  return new Date(Date.UTC(y,m-1,d,7,0,0)); // AZ UTC-7
}

// --- FIRST 4 WEEKS ---
const BASE_WEEKS = [
  { amount: 2017, bills: [
    {id:'rogue', name:'Rogue', amt:700, due:'2025-09-03'},
    {id:'fridge', name:'Fridge', amt:60, due:'2025-09-01'},
    {id:'penasco', name:'PeÃ±asco', amt:45, due:'2025-09-01'},
    {id:'vegas', name:'Vegas', amt:51, due:'2025-09-01'},
    {id:'progressive', name:'Progressive', amt:300, due:'2025-09-15'},
    {id:'kicks', name:'Kicks', amt:472, due:'2025-10-01'},
    {id:'amazon', name:'Amazon Prime', amt:50, due:'2025-09-08'}
  ]},
  { amount: 2017, bills: [
    {id:'house', name:'House payment', amt:950, due:'2025-10-01'},
    {id:'qs3064', name:'Quicksilver 3064', amt:100, due:'2025-09-11'},
    {id:'centurylink', name:'Century Link', amt:70, due:'2025-09-13'},
    {id:'tmobile', name:'T-Mobile', amt:368, due:'2025-09-15'},
    {id:'hoa', name:'HOA', amt:160, due:'2025-09-01'}
  ]},
  { amount: 650, bills: [
    {id:'hawaiian', name:'Hawaiian Airlines', amt:65, due:'2025-09-15'},
    {id:'city', name:'City of Phoenix', amt:60, due:'2025-09-04'},
    {id:'chase', name:'Chase', amt:125, due:'2025-09-15'},
    {id:'frontier', name:'Frontier', amt:65, due:'2025-09-15'}
  ]},
  { amount: 364, bills: [
    {id:'walmart', name:'Walmart', amt:75, due:'2025-09-17'},
    {id:'qs5989', name:'Quicksilver 5989', amt:100, due:'2025-09-15'},
    {id:'capitalone', name:'Capital One', amt:189, due:'2025-09-10'}
  ]}
];

function money(n){return '$'+Number(n).toLocaleString();}
let currentWeekIndex = 0;
const WEEKS = BASE_WEEKS;

// --- RENDER FUNCTIONS ---
function renderWeek(){
  const container=document.getElementById('weekContainer');
  container.innerHTML='';
  const pc=WEEKS[currentWeekIndex];
  let totalPaid=0;
  pc.bills.forEach(b=>{
    const toggleId=`${b.id}_${b.due}`;
    if(state[toggleId]) totalPaid+=b.amt;
  });
  const remaining=pc.amount-totalPaid;
  const pct=Math.round((totalPaid/pc.amount)*100);

  // Earliest due date as Pay Date
  const earliestDue=pc.bills.reduce((earliest,b)=>{
    const d=parseAZDate(b.due);
    return (!earliest||d<earliest)?d:earliest;
  }, null);
  const formattedPayDate=earliestDue.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});

  let html=`<div class="card">
    <div class="card-header">
      <h2>Pay Date: ${formattedPayDate}
      <span class="income">Income: ${money(pc.amount)}</span></h2>
    </div>
    <div class="bill-list">`;
  pc.bills.forEach(b=>{
    const toggleId=`${b.id}_${b.due}`;
    const checked=state[toggleId]?'checked':'';
    const dueDate=parseAZDate(b.due);
    const formattedDue=`${dueDate.getMonth()+1}/${dueDate.getDate()}`;
    html+=`<div class="row">
      <span><span class="bill-name">${b.name}</span> (Due: ${formattedDue}) - ${money(b.amt)}</span>
      <input type="checkbox" class="toggle" data-id="${toggleId}" ${checked}>
    </div>`;
  });
  html+=`</div>
    <div class="card-footer">
      <p>Paid: ${money(totalPaid)} | Remaining: ${money(remaining)}</p>
      <div class="progress"><i style="width:${pct}%"></i></div>
    </div>
  </div>`;
  container.innerHTML=html;
  
  renderAllSummary();
  renderMonthSummary();
}

function renderAllSummary(){
  const container=document.getElementById('allSummary');
  let planned=0, paid=0;
  WEEKS.forEach(w=>{
    w.bills.forEach(b=>{
      planned+=b.amt;
      const toggleId=`${b.id}_${b.due}`;
      if(state[toggleId]) paid+=b.amt;
    });
  });
  container.innerHTML=`<strong>Total:</strong> ${money(planned)} | <strong>Paid:</strong> ${money(paid)} | <strong>Remaining:</strong> ${money(planned-paid)}`;
}

function renderMonthSummary(){
  const container=document.getElementById('monthSummary');
  const month=parseAZDate(WEEKS[currentWeekIndex].bills[0].due).getMonth();
  const year=parseAZDate(WEEKS[currentWeekIndex].bills[0].due).getFullYear();

  const allBills=WEEKS.flatMap(w=>w.bills.map(b=>({...b, weekIndex:WEEKS.indexOf(w)})));
  const groupedBills={};
  allBills.forEach(b=>{
    const dueMonth=parseAZDate(b.due).getMonth();
    const dueYear=parseAZDate(b.due).getFullYear();
    if(dueMonth===month && dueYear===year){
      const key=`${b.name}-${b.due}`;
      if(!groupedBills[key]) groupedBills[key]={...b,isPaid:false};
      const toggleId=`${b.id}_${b.due}`;
      if(state[toggleId]) groupedBills[key].isPaid=true;
    }
  });

  const billsForDisplay=Object.values(groupedBills);
  let html=`<h3>${new Date(WEEKS[currentWeekIndex].bills[0].due).toLocaleDateString('en-US',{month:'long'})} Bills</h3>`;
  let totalPaidForMonth=0, totalPlannedForMonth=0;

  billsForDisplay.sort((a,b)=>parseAZDate(a.due)-parseAZDate(b.due));
  billsForDisplay.forEach(b=>{
    totalPlannedForMonth+=b.amt;
    if(b.isPaid) totalPaidForMonth+=b.amt;
    const dueDate=parseAZDate(b.due);
    const formattedDue=`${dueDate.getMonth()+1}/${dueDate.getDate()}`;
    const paidClass=b.isPaid?'paid-amount':'';
    html+=`<div class="bill-item">
      <span><strong>${b.name}</strong> (Due: ${formattedDue})</span>
      <span class="${paidClass}">${money(b.amt)}</span>
    </div>`;
  });

  container.innerHTML=html;
  if(totalPaidForMonth===totalPlannedForMonth && totalPlannedForMonth>0){
    container.style.backgroundColor='#179d4d';
    container.style.color='white';
  } else{
    container.style.backgroundColor='#171923';
    container.style.color='#e6e8f0';
  }
}

// --- TOGGLE HANDLER ---
document.addEventListener('change', async e=>{
  if(e.target.matches('.toggle')){
    const id=e.target.dataset.id;
    state[id]=e.target.checked;
    try{await setDoc(TOGGLE_DOC,{[id]:state[id]},{merge:true});}
    catch(err){console.warn("Error saving:",err);}
    renderWeek();
  }
});

// --- SWIPE & PULL-TO-REFRESH ---
let touchStartX=0, touchStartY=0, touchEndX=0, touchEndY=0;
const SWIPE_THRESHOLD=50;
const weekContainer=document.getElementById('weekContainer');

weekContainer.addEventListener('touchstart', e=>{
  touchStartX=e.touches[0].screenX;
  touchStartY=e.touches[0].screenY;
},{passive:false});

weekContainer.addEventListener('touchmove', e=>{
  touchEndX=e.touches[0].screenX;
  touchEndY=e.touches[0].screenY;
  const deltaY=touchEndY-touchStartY;
  if(window.scrollY===0 && deltaY>0){
    e.preventDefault();
    document.body.style.transform=`translateY(${deltaY}px)`;
  }
},{passive:false});

weekContainer.addEventListener('touchend', e=>{
  const deltaX=touchEndX-touchStartX;
  const deltaY=touchEndY-touchStartY;

  // Horizontal swipe only if deltaX bigger than deltaY
  if(Math.abs(deltaX)>Math.abs(deltaY) && Math.abs(deltaX)>SWIPE_THRESHOLD){
    if(deltaX<0 && currentWeekIndex<WEEKS.length-1) currentWeekIndex++;
    if(deltaX>0 && currentWeekIndex>0) currentWeekIndex--;
    renderWeek();
  }

  // Reset touch coordinates
  touchStartX=touchStartY=touchEndX=touchEndY=0;

  // Pull-to-refresh
  if(window.scrollY===0 && deltaY>80) window.location.reload();
  document.body.style.transform='translateY(0)';
},{passive:false});

// --- Firebase Auth & Load ---
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, async user=>{
  if(user){
    try{
      const snap=await getDoc(TOGGLE_DOC);
      state=snap.exists()?snap.data():{};
    } catch(e){console.warn("Error reading Firestore:",e);}
    renderWeek();
  }
});
</script>

<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=>console.log('Service Worker registered'));
}
</script>
</body>
</html>
