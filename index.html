<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ’° Budget Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f4f4f4; }
    h2 { margin-top:30px; }
    .paydate, .overview {
      background:#fff; padding:15px; margin:15px 0; border-radius:10px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
    .bill { display:flex; justify-content:space-between; margin:5px 0; }
    .progress { background:#ddd; border-radius:5px; overflow:hidden; height:20px; margin-top:10px; }
    .progress-bar { background:#4caf50; height:100%; width:0%; text-align:center; color:#fff; font-size:12px; }
  </style>
</head>
<body>
  <h1>ðŸ’° Budget Tracker</h1>
  <div id="app"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { initializeFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // === Firebase config ===
    const firebaseConfig = {
      apiKey: "AIzaSyC7ubmyUmeCAun50g-AUUOHiuwpGAys2HM",
      authDomain: "budget-tracker-1eea7.firebaseapp.com",
      projectId: "budget-tracker-1eea7",
      storageBucket: "budget-tracker-1eea7.firebasestorage.app",
      messagingSenderId: "579",
      appId: "1:579:web:demo"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    // ðŸš« Disable Firestore local cache to avoid corruption
    const db = initializeFirestore(app, { localCache: undefined });

    // === Paydate data (Arizona time) ===
    const paydates = [
      {
        date: "2025-08-22", income: 2017,
        bills: [
          { name: "Kicks", amount: 472 },
          { name: "Progressive", amount: 300 },
          { name: "Rogue", amount: 700 },
          { name: "Fridge", amount: 60 },
          { name: "PeÃ±asco", amount: 45 },
          { name: "Vegas", amount: 51 },
          { name: "Amazon Prime", amount: 50 },
        ]
      },
      {
        date: "2025-08-29", income: 650,
        bills: [
          { name: "Hawaiian Air", amount: 65 },
          { name: "City of Phoenix", amount: 60 },
          { name: "Chase", amount: 125 },
          { name: "Frontier", amount: 65 },
        ]
      },
      {
        date: "2025-09-05", income: 2017,
        bills: [
          { name: "House Payment", amount: 950 },
          { name: "QS 3064", amount: 100 },
          { name: "Century Link", amount: 70 },
          { name: "T-Mobile", amount: 368 },
          { name: "HOA", amount: 160 },
        ]
      },
      {
        date: "2025-09-12", income: 650,
        bills: [
          { name: "Walmart", amount: 75 },
          { name: "Quicksilver 5989", amount: 100 },
          { name: "Capital One", amount: 189 },
        ]
      }
    ];

    // === Render function ===
    function render(uid, userToggles) {
      const appDiv = document.getElementById("app");
      appDiv.innerHTML = "";

      let monthTotals = {};

      paydates.forEach(pd => {
        const div = document.createElement("div");
        div.className = "paydate";

        let totalBills = pd.bills.reduce((s,b) => s+b.amount, 0);
        let remaining = pd.income - totalBills;

        div.innerHTML = `<h2>${new Date(pd.date+"T00:00:00-07:00").toLocaleDateString("en-US",{timeZone:"America/Phoenix"})} â€” $${pd.income}</h2>
          <div id="bills-${pd.date}"></div>
          <div class="progress"><div class="progress-bar" id="bar-${pd.date}">0%</div></div>
          <p><b>Total:</b> $${totalBills}</p>
          <p><b>Remaining:</b> $${remaining}</p>`;
        appDiv.appendChild(div);

        const billsDiv = div.querySelector(`#bills-${pd.date}`);
        pd.bills.forEach(b => {
          const billId = pd.date + "_" + b.name.replace(/\s+/g,"_");
          const isChecked = userToggles[billId]?.checked || false;

          billsDiv.innerHTML += `
            <div class="bill">
              <label><input type="checkbox" data-id="${billId}" ${isChecked?"checked":""}/> ${b.name}</label>
              <span>$${b.amount}</span>
            </div>`;
        });

        // Track totals per month
        const m = pd.date.slice(0,7); // YYYY-MM
        if (!monthTotals[m]) monthTotals[m] = { income:0, bills:0 };
        monthTotals[m].income += pd.income;
        monthTotals[m].bills += totalBills;
      });

      // === Month overview ===
      Object.entries(monthTotals).forEach(([month, vals]) => {
        const div = document.createElement("div");
        div.className = "overview";
        div.innerHTML = `<h2>${month} Overview</h2>
          <p><b>Income:</b> $${vals.income}</p>
          <p><b>Total Bills:</b> $${vals.bills}</p>
          <p><b>Remaining:</b> $${vals.income - vals.bills}</p>`;
        appDiv.appendChild(div);
      });

      // === Progress handling ===
      function updateBars() {
        paydates.forEach(pd => {
          const bills = pd.bills.map(b=>pd.date+"_"+b.name.replace(/\s+/g,"_"));
          const checked = bills.filter(id => document.querySelector(`[data-id="${id}"]`)?.checked).length;
          const pct = bills.length? Math.round((checked/bills.length)*100):0;
          const bar = document.getElementById("bar-"+pd.date);
          if(bar) { bar.style.width = pct+"%"; bar.textContent = pct+"%"; }
        });
      }
      updateBars();

      // === Save toggle to Firestore ===
      document.querySelectorAll("input[type=checkbox]").forEach(cb=>{
        cb.addEventListener("change", e=>{
          const toggleId = e.target.dataset.id;
          setDoc(doc(db,"users",uid,"toggles",toggleId), { checked:e.target.checked });
          updateBars();
        });
      });
    }

    // === Auth + Firestore sync ===
    signInAnonymously(auth).catch(err=>console.error("Auth error", err));
    onAuthStateChanged(auth, user=>{
      if(user){
        const uid = user.uid;
        onSnapshot(collection(db,"users",uid,"toggles"), snap=>{
          let toggles={};
          snap.forEach(d=>toggles[d.id]=d.data());
          render(uid, toggles);
        });
      }
    });
  </script>
</body>
</html>
