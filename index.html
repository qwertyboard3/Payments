<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pagos</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="icons/pagos-icon-192.png">
<meta name="theme-color" content="#7c5cff">
<style>
  body{margin:0;padding:20px;font-family:system-ui;background:#0f1115;color:#e6e8f0;font-size:18px;}
  h1{text-align:center;margin:16px 0;}
  .card{background:#171923;padding:20px;border-radius:12px;margin-bottom:20px;min-height:300px;display:flex;flex-direction:column;justify-content:space-between;transition:transform 0.3s ease-in-out;}
  .card h2{text-align:center;margin-bottom:10px;font-size:22px;}
  .card .income{font-size:18px;margin-top:5px;display:block;}
  .row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #2a2f3a;}
  .row:last-child{border-bottom:none;}
  .row .bill-name{font-weight:bold;}
  .toggle{appearance:none;width:50px;height:26px;border-radius:26px;position:relative;background:#252a36;border:1px solid #394055;cursor:pointer;transition:.2s;}
  .toggle::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#8a93a8;transition:.2s;}
  .toggle:checked{background:linear-gradient(90deg,#1db954,#22d06e);border-color:#179d4d;}
  .toggle:checked::after{left:23px;background:white;}
  .progress{height:10px;background:#242938;border-radius:8px;overflow:hidden;margin-top:10px;border:1px solid #32384e;}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,#7c5cff,#22d06e);width:0%;}
  .summary{margin-top:16px;padding:16px;background:#171923;border-radius:10px;font-size:18px;text-align:center;}
  .month-summary{margin-top:10px;padding:12px;border-radius:10px;font-size:16px; transition: background-color 0.5s ease;}
  .month-summary.all-paid{background-color: #179d4d; color: white;}
  .month-summary h3{margin-top:0;font-size:18px;text-align:center;}
  .bill-item{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid #2a2f3a;}
  .bill-item:last-child{border-bottom:none;}
  .bill-item .paid-amount{color: #1db954;}
  .navigation-buttons{display:none;}
</style>
</head>
<body>
<h1>Pagos</h1>
<section id="weekContainer"></section>
<div class="navigation-buttons">
  <button id="prevWeek">Previous</button>
  <button id="nextWeek">Next</button>
</div>
<div class="summary" id="allSummary"></div>
<div class="month-summary" id="monthSummary"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC7ubmyUmeCAun50g-AUUOHiuwpGAys2HM",
  authDomain: "budget-tracker-1eea7.firebaseapp.com",
  projectId: "budget-tracker-1eea7",
  storageBucket: "budget-tracker-1eea7.firebasestorage.app",
  messagingSenderId: "579597071031",
  appId: "1:579597071031:web:f30c2d42cc57268707d332"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const TOGGLE_DOC = doc(db,"toggles","weeklyState");
let state = {};

const BASE_WEEKS = [
  { amount: 2017, bills: [
    {id:'kicks',name:'Kicks',amt:472,due:'10/01/2025'},
    {id:'progressive',name:'Progressive',amt:300,due:'09/15/2025'},
    {id:'rogue',name:'Rogue',amt:700,due:'09/03/2025'},
    {id:'fridge',name:'Fridge',amt:60,due:'09/01/2025'},
    {id:'penasco',name:'Pe√±asco',amt:45,due:'09/01/2025'},
    {id:'vegas',name:'Vegas',amt:51,due:'09/01/2025'},
    {id:'amazon',name:'Amazon',amt:50,due:'09/08/2025'}
  ]},
  { amount: 2017, bills: [
    {id:'hoa',name:'HOA',amt:160,due:'09/01/2025'},
    {id:'city',name:'City of Phoenix',amt:60,due:'09/04/2025'},
    {id:'qs3064',name:'Quicksilver 3064',amt:100,due:'09/11/2025'},
    {id:'centurylink',name:'Century Link',amt:70,due:'09/13/2025'},
    {id:'capitalone',name:'Capital One',amt:189,due:'09/10/2025'},
    {id:'tmobile',name:'T-Mobile',amt:368,due:'09/15/2025'},
    {id:'qs5989',name:'Quicksilver 5989',amt:100,due:'09/15/2025'},
    {id:'frontier',name:'Frontier',amt:65,due:'09/15/2025'},
    {id:'chase',name:'Chase',amt:125,due:'09/15/2025'},
    {id:'hawaiian',name:'Hawaiian Airlines',amt:65,due:'09/15/2025'},
    {id:'walmart',name:'Walmart',amt:75,due:'09/17/2025'},
    {id:'house',name:'House payment',amt:950,due:'10/01/2025'}
  ]}
];

function generateWeeks(startDate, numWeeks){
  const weeks=[];
  let date = new Date(startDate);
  for(let i=0;i<numWeeks;i++){
    const pattern = BASE_WEEKS[i%BASE_WEEKS.length];
    const w = {amount:pattern.amount,bills:pattern.bills.map(b=>{
      const due = new Date(b.due);
      const newDue = new Date(due.getFullYear(), due.getMonth(), due.getDate());
      newDue.setDate(newDue.getDate() + 7 * Math.floor(i / BASE_WEEKS.length) * BASE_WEEKS.length);
      return {...b, due: newDue.toISOString().slice(0,10)};
    })};
    w.date = date.toISOString().slice(0,10);
    weeks.push(w);
    date.setDate(date.getDate()+7);
  }
  return weeks;
}

const WEEKS = generateWeeks('2025-08-22', 12);
let currentWeekIndex = 0;

function money(n){return '$'+Number(n).toLocaleString();}

function renderWeek(){
  const container = document.getElementById('weekContainer');
  container.innerHTML='';
  const pc = WEEKS[currentWeekIndex];
  let totalPaid=0;
  pc.bills.forEach(b=>{
    const toggleId = `${b.id}_${pc.date}`;
    if(state[toggleId]) totalPaid+=b.amt;
  });
  const remaining = pc.amount - totalPaid;
  const pct = Math.round((totalPaid/pc.amount)*100);

  let html = `<div class="card">
    <div class="card-header">
      <h2>Pay Date: ${new Date(pc.date).toLocaleDateString('en-US',{month:'long',day:'numeric', year:'numeric'})}
      <span class="income">Income: ${money(pc.amount)}</span></h2>
    </div>
    <div class="bill-list">`;
  pc.bills.forEach(b=>{
    const toggleId = `${b.id}_${pc.date}`;
    const checked = state[toggleId]?'checked':'';
    const dueDate = new Date(b.due);
    const formattedDue = `${dueDate.getMonth()+1}/${dueDate.getDate()}`;
    html+=`<div class="row">
      <span><span class="bill-name">${b.name}</span> (Due: ${formattedDue}) - ${money(b.amt)}</span>
      <input type="checkbox" class="toggle" data-id="${toggleId}" ${checked}>
    </div>`;
  });
  html+=`</div>
    <div class="card-footer">
      <p>Paid: ${money(totalPaid)} | Remaining: ${money(remaining)}</p>
      <div class="progress"><i style="width:${pct}%"></i></div>
    </div>
  </div>`;
  container.innerHTML = html;
  
  renderAllSummary();
  renderMonthSummary();
}

function renderAllSummary(){
  const container = document.getElementById('allSummary');
  let planned=0, paid=0;
  WEEKS.forEach(w=>{
    w.bills.forEach(b=>{
      planned+=b.amt;
      const toggleId = `${b.id}_${w.date}`;
      if(state[toggleId]) paid+=b.amt;
    });
  });
  const remaining = planned - paid;
  container.innerHTML = `<strong>Total:</strong> ${money(planned)} | <strong>Paid:</strong> ${money(paid)} | <strong>Remaining:</strong> ${money(remaining)}`;
}

function renderMonthSummary(){
  const container = document.getElementById('monthSummary');
  const month = new Date(WEEKS[currentWeekIndex].date).getMonth();
  const year = new Date(WEEKS[currentWeekIndex].date).getFullYear();

  const allBills = WEEKS.flatMap(w => w.bills.map(b => ({...b, weekDate: w.date})));
  
  const groupedBills = {};
  allBills.forEach(b => {
      const dueMonth = new Date(b.due).getMonth();
      const dueYear = new Date(b.due).getFullYear();
      if(dueMonth === month && dueYear === year) {
          const key = `${b.name}-${b.due}`;
          if (!groupedBills[key]) {
              groupedBills[key] = {...b, isPaid: false};
          }
          const toggleId = `${b.id}_${b.weekDate}`;
          if (state[toggleId]) {
              groupedBills[key].isPaid = true;
          }
      }
  });

  const billsForDisplay = Object.values(groupedBills);

  let totalPaidForMonth = 0;
  let totalPlannedForMonth = 0;

  let html = `<h3>${new Date(WEEKS[currentWeekIndex].date).toLocaleDateString('en-US', {month:'long'})} Bills</h3>`;
  
  billsForDisplay.sort((a,b) => new Date(a.due) - new Date(b.due));

  if (billsForDisplay.length > 0) {
    billsForDisplay.forEach(b => {
        totalPlannedForMonth += b.amt;
        if(b.isPaid) totalPaidForMonth += b.amt;
        const dueDate = new Date(b.due);
        const formattedDue = `${dueDate.getMonth()+1}/${dueDate.getDate()}`;
        const paidClass = b.isPaid ? 'paid-amount' : '';
        html += `<div class="bill-item">
                    <span><strong>${b.name}</strong> (Due: ${formattedDue})</span>
                    <span class="${paidClass}">${money(b.amt)}</span>
                </div>`;
    });
  } else {
    html += `<p style="text-align: center;">No bills due this month.</p>`;
  }

  container.innerHTML = html;

  if (totalPaidForMonth === totalPlannedForMonth && totalPlannedForMonth > 0) {
      container.style.backgroundColor = '#179d4d';
      container.style.color = 'white';
  } else {
      container.style.backgroundColor = '#171923';
      container.style.color = '#e6e8f0';
  }
}

document.addEventListener('change', async e=>{
  if(e.target.matches('.toggle')){
    const id = e.target.dataset.id;
    state[id] = e.target.checked;
    try{ await setDoc(TOGGLE_DOC,{[id]:state[id]},{merge:true}); }
    catch(err){ console.warn("Error saving:",err); }
    renderWeek();
  }
});

let touchstartX = 0;
let touchendX = 0;
const SWIPE_THRESHOLD = 100;
const weekContainer = document.getElementById('weekContainer');

function handleGesture() {
  if (touchendX < touchstartX - SWIPE_THRESHOLD) {
    if (currentWeekIndex < WEEKS.length - 1) {
      currentWeekIndex++;
      renderWeek();
    }
  }
  if (touchendX > touchstartX + SWIPE_THRESHOLD) {
    if (currentWeekIndex > 0) {
      currentWeekIndex--;
      renderWeek();
    }
  }
}

weekContainer.addEventListener('touchstart', e => {
  touchstartX = e.changedTouches[0].screenX;
});

weekContainer.addEventListener('touchend', e => {
  touchendX = e.changedTouches[0].screenX;
  handleGesture();
});

// Pull to refresh logic for PWA
let startY = 0;
let endY = 0;
const PULL_THRESHOLD = 80;

document.addEventListener('touchstart', e => {
    startY = e.touches[0].pageY;
});

document.addEventListener('touchmove', e => {
    endY = e.touches[0].pageY;
    if (window.scrollY === 0 && endY > startY) {
        document.body.style.transform = `translateY(${endY - startY}px)`;
    }
});

document.addEventListener('touchend', e => {
    if (window.scrollY === 0 && (endY - startY) > PULL_THRESHOLD) {
        window.location.reload();
    }
    document.body.style.transform = `translateY(0)`;
});

signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, async user=>{
  if(user){
    try{
      const snap = await getDoc(TOGGLE_DOC);
      state = snap.exists()?snap.data():{};
    }catch(e){ console.warn("Error reading Firestore:",e); }
    const today = new Date();
    WEEKS.forEach((w,i)=>{
      const start = new Date(w.date);
      const end = new Date(start);
      end.setDate(start.getDate()+6);
      if(today>=start && today<=end) currentWeekIndex=i;
    });
    renderWeek();
  }
});
</script>
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=>console.log('Service Worker registered'));
}
</script>
</body>
</html>
