<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4-Week Payment Tracker</title>
<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:0; background:#0f1115; color:#e6e8f0; }
header { position: sticky; top:0; background:#171923; padding:1rem; border-bottom:1px solid #2a2f3a; text-align:center; font-weight:bold; }
.week-nav { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 1rem; background:#171923; border-bottom:1px solid #2a2f3a; }
.week-card { margin:1rem; padding:1rem; background:#171923; border-radius:16px; box-shadow:0 2px 6px rgba(0,0,0,0.25); }
.progress { height:8px; border-radius:8px; background:#242938; margin:0.5rem 0 1rem; overflow:hidden; border:1px solid #32384e; }
.progress-bar { height:100%; background:linear-gradient(90deg,#7c5cff,#22d06e); width:0%; transition:width 0.3s; }
.bill { display:flex; justify-content:space-between; align-items:center; padding:0.75rem 0; border-bottom:1px solid #2a2f3a; }
.bill:last-child { border-bottom:none; }
.ios-switch { position:relative; display:inline-block; width:52px; height:32px; }
.ios-switch input { display:none; }
.slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#252a36; border-radius:32px; transition:.4s; border:1px solid #394055; }
.slider:before { position:absolute; content:""; height:24px; width:24px; left:4px; bottom:4px; background:white; border-radius:50%; transition:.4s; box-shadow:0 1px 2px rgba(0,0,0,.45); }
input:checked + .slider { background:linear-gradient(90deg,#1db954,#22d06e); border-color:#179d4d; }
input:checked + .slider:before { transform:translateX(20px); background:white; }
#debug { background:#222; color:#0f0; padding:1rem; font-family:monospace; overflow:auto; max-height:200px; }
button { background:#7c5cff; border:none; padding:0.5rem 1rem; border-radius:8px; color:#fff; cursor:pointer; }
button:hover { background:#5a42c8; }
</style>
</head>
<body>
<header id="totals">Loading...</header>
<div class="week-nav">
  <button id="prevWeek">◀︎</button>
  <div id="weekLabel">Week</div>
  <button id="nextWeek">▶︎</button>
</div>
<div id="weekContainer"></div>
<div id="debug"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

// ===== Replace with your Firebase config =====
const firebaseConfig = {
  apiKey: "AIzaSyC7ubmyUmeCAun50g-AUUOHiuwpGAys2HM",
  authDomain: "budget-tracker-1eea7.firebaseapp.com",
  projectId: "budget-tracker-1eea7",
  storageBucket: "budget-tracker-1eea7.appspot.com", // <- must be appspot.com
  messagingSenderId: "579597071031",
  appId: "1:579597071031:web:f30c2d42cc57268707d332"
};
// ============================================
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const debugEl = document.getElementById("debug");
function logDebug(msg){ debugEl.innerHTML += msg + "<br>"; debugEl.scrollTop = debugEl.scrollHeight; }

const startDate = new Date("2025-08-22");
const weekLength = 7*24*60*60*1000;
let currentWeek;

const defaultBills = [
  {id:"phoenix", name:"City of Phoenix", amount:60},
  {id:"quicksilver", name:"Quicksilver 3064", amount:100},
  {id:"progressive", name:"Progressive", amount:300},
  {id:"fridge", name:"Fridge", amount:60},
  {id:"amazon", name:"Amazon Prime", amount:50},
];

async function renderWeek(weekNum){
  logDebug(`Rendering week ${weekNum}...`);
  const weekDoc = doc(db, "weeks", "week"+weekNum);
  let snap;
  try {
    snap = await getDoc(weekDoc);
    logDebug(`Firestore read: ${snap.exists() ? "exists" : "not exists"}`);
  } catch(e){
    logDebug("Error reading Firestore: " + e.message);
    return;
  }

  let state = snap.exists() ? snap.data() : {};
  if(!snap.exists()){
    const initialState = {};
    defaultBills.forEach(b=>initialState[b.id]=false);
    try{
      await setDoc(weekDoc, initialState);
      logDebug("Created new Firestore week doc");
    }catch(e){ logDebug("Error creating doc: "+e.message);}
    state = initialState;
  }

  const weekStart = new Date(startDate.getTime() + (weekNum-1)*weekLength);
  const weekEnd = new Date(weekStart.getTime() + weekLength -1);
  document.getElementById("weekLabel").textContent = `Week ${weekNum} (${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()})`;

  let paidCount = 0;
  let html = `<div class="week-card"><div class="progress"><div class="progress-bar" id="progressBar"></div></div>`;
  defaultBills.forEach(b=>{
    const checked = state[b.id] || false;
    if(checked) paidCount++;
    html += `<div class="bill">
      <span>${b.name} - $${b.amount}</span>
      <label class="ios-switch">
        <input type="checkbox" data-id="${b.id}" ${checked?"checked":""}>
        <span class="slider"></span>
      </label>
    </div>`;
  });
  html += `</div>`;
  document.getElementById("weekContainer").innerHTML = html;

  document.getElementById("progressBar").style.width = defaultBills.length ? (paidCount/defaultBills.length*100)+"%" : "0%";
  document.getElementById("totals").textContent = `Paid: $${defaultBills.filter(b=>state[b.id]).reduce((a,b)=>a+b.amount,0)} / $${defaultBills.reduce((a,b)=>a+b.amount,0)}`;

  document.querySelectorAll("input[type=checkbox]").forEach(cb=>{
    cb.onchange = async e=>{
      state[e.target.dataset.id] = e.target.checked;
      try{
        await setDoc(weekDoc, state, {merge:true});
        logDebug(`Saved ${e.target.dataset.id}=${e.target.checked}`);
      }catch(err){ logDebug("Error saving: "+err.message);}
      renderWeek(weekNum);
    };
  });
}

// Navigation
document.getElementById("prevWeek").onclick = ()=>{ if(currentWeek>1){ currentWeek--; renderWeek(currentWeek); } };
document.getElementById("nextWeek").onclick = ()=>{ currentWeek++; renderWeek(currentWeek); };

// Firebase Auth
signInAnonymously(auth)
  .then(u=> logDebug("Signed in: " + u.user.uid))
  .catch(err=> logDebug("Auth error: "+err.message));

onAuthStateChanged(auth, user=>{
  if(user){
    logDebug("onAuthStateChanged: signed in");
    const today = new Date();
    currentWeek = Math.floor((today - startDate)/weekLength)+1;
    if(currentWeek<1) currentWeek=1;
    renderWeek(currentWeek);
  } else {
    logDebug("onAuthStateChanged: not signed in");
  }
});
</script>
</body>
</html>