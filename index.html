<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { 
  initializeFirestore, 
  memoryLocalCache, 
  doc, getDoc, setDoc 
} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC7ubmyUmeCAun50g-AUUOHiuwpGAys2HM",
  authDomain: "budget-tracker-1eea7.firebaseapp.com",
  projectId: "budget-tracker-1eea7",
  storageBucket: "budget-tracker-1eea7.firebasestorage.app",
  messagingSenderId: "579597071031",
  appId: "1:579597071031:web:f30c2d42cc57268707d332"
};

const app = initializeApp(firebaseConfig);

// ✅ Force memory-only cache (no IndexedDB, avoids corruption)
const db = initializeFirestore(app, {
  localCache: memoryLocalCache()
});

const auth = getAuth(app);
const TOGGLE_DOC = doc(db,"toggles","weeklyState");
let state = {};

// === Bills & Pay Dates ===
const MASTER_BILLS = [
  {id:'city',name:'City of Phoenix',amt:60,due:'09/04/2025'},
  {id:'qs3064',name:'Quicksilver 3064',amt:100,due:'09/11/2025'},
  {id:'progressive',name:'Progressive',amt:300,due:'09/15/2025'},
  {id:'centurylink',name:'Century Link',amt:70,due:'09/13/2025'},
  {id:'tmobile',name:'T-Mobile',amt:368,due:'09/15/2025'},
  {id:'house',name:'House payment',amt:950,due:'10/01/2025'},
  {id:'rogue',name:'Rogue',amt:700,due:'09/03/2025'},
  {id:'hoa',name:'HOA',amt:160,due:'09/01/2025'},
  {id:'kicks',name:'Kicks',amt:472,due:'10/01/2025'},
  {id:'amazon',name:'Amazon',amt:50,due:'09/08/2025'},
  {id:'walmart',name:'Walmart',amt:75,due:'09/17/2025'},
  {id:'qs5989',name:'Quicksilver 5989',amt:100,due:'09/15/2025'},
  {id:'capitalone',name:'Capital One',amt:189,due:'09/10/2025'},
  {id:'frontier',name:'Frontier',amt:65,due:'09/15/2025'},
  {id:'chase',name:'Chase',amt:125,due:'09/15/2025'},
  {id:'hawaiian',name:'Hawaiian Airlines',amt:65,due:'09/15/2025'},
  {id:'fridge',name:'Fridge',amt:60,due:'09/01/2025'},
  {id:'penasco',name:'Peñasco',amt:45,due:'09/01/2025'},
  {id:'vegas',name:'Vegas',amt:51,due:'09/01/2025'}
];

const PAY_DATES = [
  { date: '2025-08-22', amount: 2017 },
  { date: '2025-08-29', amount: 650 },
  { date: '2025-09-05', amount: 2017 },
  { date: '2025-09-12', amount: 650 },
  { date: '2025-09-19', amount: 2017 },
  { date: '2025-09-26', amount: 650 },
  { date: '2025-10-03', amount: 2017 },
];

// === Functions ===
function generateWeeks() {
  const weeks = [];
  for (let i = 0; i < PAY_DATES.length; i++) {
    const payDate = PAY_DATES[i].date;
    const income = PAY_DATES[i].amount;

    let nextPayDate = new Date(new Date(payDate + 'T12:00:00'));
    nextPayDate.setDate(nextPayDate.getDate() + 7);

    if (i < PAY_DATES.length - 1) {
        nextPayDate = new Date(PAY_DATES[i + 1].date + 'T12:00:00');
    }

    const billsForWeek = MASTER_BILLS.filter(bill => {
      const dueDate = new Date(bill.due + 'T12:00:00');
      const payDateObj = new Date(payDate + 'T12:00:00');
      return dueDate >= payDateObj && dueDate < nextPayDate;
    });

    weeks.push({
      date: payDate,
      amount: income,
      bills: billsForWeek
    });
  }
  return weeks;
}

const WEEKS = generateWeeks();   // ✅ put this back
let currentWeekIndex = 0;

// ... keep your renderWeek(), renderAllSummary(), renderMonthSummary(),
// event listeners, swipe logic, pull-to-refresh here unchanged ...

// === Auth & Firestore sync ===
signInAnonymously(auth).catch(console.error);

onAuthStateChanged(auth, async user=>{
  if(user){
    try{
      const snap = await getDoc(TOGGLE_DOC);
      state = snap.exists()?snap.data():{};
    }catch(e){ console.warn("Error reading Firestore:",e); }
    const today = new Date();
    WEEKS.forEach((w,i)=>{
      const start = new Date(w.date);
      const end = new Date(start);
      end.setDate(start.getDate()+6);
      if(today>=start && today<=end) currentWeekIndex=i;
    });
    renderWeek();
  }
});
</script>
