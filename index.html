<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC7ubmyUmeCAun50g-AUUOHiuwpGAys2HM",
  authDomain: "budget-tracker-1eea7.firebaseapp.com",
  projectId: "budget-tracker-1eea7",
  storageBucket: "budget-tracker-1eea7.firebasestorage.app",
  messagingSenderId: "579597071031",
  appId: "1:579597071031:web:f30c2d42cc57268707d332"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const TOGGLE_DOC = doc(db,"toggles","weeklyState");
let state = {};
console.log("Firebase initialized.");

// --- Arizona date helper ---
function parseAZDate(str){
  const [y,m,d]=str.split('-').map(Number);
  return new Date(Date.UTC(y,m-1,d,7,0,0)); // AZ UTC-7
}

// --- All bills ---
const ALL_BILLS = [
{id:'rogue', name:'Rogue', amt:700, due:'2025-09-03'},
{id:'fridge', name:'Fridge', amt:60, due:'2025-09-01'},
{id:'penasco', name:'Pe√±asco', amt:45, due:'2025-09-01'},
{id:'vegas', name:'Vegas', amt:51, due:'2025-09-01'},
{id:'progressive', name:'Progressive', amt:300, due:'2025-09-15'},
{id:'kicks', name:'Kicks', amt:472, due:'2025-10-01'},
{id:'amazon', name:'Amazon Prime', amt:50, due:'2025-09-08'},
{id:'house', name:'House payment', amt:950, due:'2025-10-01'},
{id:'qs3064', name:'Quicksilver 3064', amt:100, due:'2025-09-11'},
{id:'centurylink', name:'Century Link', amt:70, due:'2025-09-13'},
{id:'tmobile', name:'T-Mobile', amt:368, due:'2025-09-15'},
{id:'hoa', name:'HOA', amt:160, due:'2025-09-01'},
{id:'hawaiian', name:'Hawaiian Airlines', amt:65, due:'2025-09-15'},
{id:'city', name:'City of Phoenix', amt:60, due:'2025-09-04'},
{id:'chase', name:'Chase', amt:125, due:'2025-09-15'},
{id:'frontier', name:'Frontier', amt:65, due:'2025-09-15'},
{id:'walmart', name:'Walmart', amt:75, due:'2025-09-17'},
{id:'qs5989', name:'Quicksilver 5989', amt:100, due:'2025-09-15'},
{id:'capitalone', name:'Capital One', amt:189, due:'2025-09-10'}
];

const START_DATE='2025-08-22';
const NUM_WEEKS=12;

// --- Generate weekly schedule ---
function generateWeeks(startDate,numWeeks){
  const start=parseAZDate(startDate);
  const weeks=[];
  for(let i=0;i<numWeeks;i++){
    const weekStart=new Date(start);
    weekStart.setDate(start.getDate()+i*7);
    const billsThisWeek=ALL_BILLS.filter(b=>{
      const due=parseAZDate(b.due);
      return due>=weekStart && due<new Date(weekStart.getTime()+7*24*60*60*1000);
    });
    const amount=billsThisWeek.reduce((acc,b)=>acc+b.amt,0);
    weeks.push({date:weekStart.toISOString().slice(0,10),amount,bills:billsThisWeek});
  }
  return weeks;
}

const WEEKS=generateWeeks(START_DATE,NUM_WEEKS);
let currentWeekIndex=0;
function money(n){return '$'+Number(n).toLocaleString();}

// --- Render ---
function renderWeek(){
  console.log("Rendering week index:", currentWeekIndex);
  const container=document.getElementById('weekContainer');
  container.innerHTML='';
  const pc=WEEKS[currentWeekIndex];
  let totalPaid=0;
  pc.bills.forEach(b=>{const toggleId=`${b.id}_${b.due}`; if(state[toggleId]) totalPaid+=b.amt;});
  const remaining=pc.amount-totalPaid;
  const pct=Math.round((totalPaid/pc.amount)*100);

  const earliestDue=pc.bills.reduce((earliest,b)=>{
    const d=parseAZDate(b.due);
    return (!earliest||d<earliest)?d:earliest;
  }, null);
  const formattedPayDate=earliestDue?earliestDue.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}):'N/A';

  let html=`<div class="card">
    <div class="card-header">
      <h2>Pay Date: ${formattedPayDate}
      <span class="income">Income: ${money(pc.amount)}</span></h2>
    </div>
    <div class="bill-list">`;

  pc.bills.forEach(b=>{
    const toggleId=`${b.id}_${b.due}`;
    const checked=state[toggleId]?'checked':'';
    const dueDate=parseAZDate(b.due);
    const formattedDue=`${dueDate.getMonth()+1}/${dueDate.getDate()}`;
    html+=`<div class="row">
      <label>
        <span class="bill-name">${b.name}</span> (Due: ${formattedDue}) - ${money(b.amt)}
        <input type="checkbox" class="toggle" data-id="${toggleId}" ${checked}>
      </label>
    </div>`;
  });
  html+=`</div>
    <div class="card-footer">
      <p>Paid: ${money(totalPaid)} | Remaining: ${money(remaining)}</p>
      <div class="progress"><i style="width:${pct}%"></i></div>
    </div>
  </div>`;
  container.innerHTML=html;
  renderAllSummary();
  renderMonthSummary();
}

function renderAllSummary(){
  const container=document.getElementById('allSummary');
  let planned=0,paid=0;
  WEEKS.forEach(w=>{w.bills.forEach(b=>{planned+=b.amt;const toggleId=`${b.id}_${b.due}`;if(state[toggleId]) paid+=b.amt;});});
  container.innerHTML=`<strong>Total:</strong> ${money(planned)} | <strong>Paid:</strong> ${money(paid)} | <strong>Remaining:</strong> ${money(planned-paid)}`;
}

function renderMonthSummary(){
  const container=document.getElementById('monthSummary');
  const month=parseAZDate(WEEKS[currentWeekIndex].date).getMonth();
  const year=parseAZDate(WEEKS[currentWeekIndex].date).getFullYear();
  const allBills=WEEKS.flatMap(w=>w.bills.map(b=>({...b,weekIndex:WEEKS.indexOf(w)})));
  const groupedBills={};
  allBills.forEach(b=>{
    const dueMonth=parseAZDate(b.due).getMonth();
    const dueYear=parseAZDate(b.due).getFullYear();
    if(dueMonth===month && dueYear===year){
      const key=`${b.name}-${b.due}`;
      if(!groupedBills[key]) groupedBills[key]={...b,isPaid:false};
      const toggleId=`${b.id}_${b.due}`;
      if(state[toggleId]) groupedBills[key].isPaid=true;
    }
  });
  const billsForDisplay=Object.values(groupedBills);
  let html=`<h3>${new Date(WEEKS[currentWeekIndex].date).toLocaleDateString('en-US',{month:'long'})} Bills</h3>`;
  billsForDisplay.sort((a,b)=>parseAZDate(a.due)-parseAZDate(b.due));
  billsForDisplay.forEach(b=>{
    const paidClass=b.isPaid?'paid-amount':'';
    const dueDate=parseAZDate(b.due);
    const formattedDue=`${dueDate.getMonth()+1}/${dueDate.getDate()}`;
    html+=`<div class="bill-item"><span><strong>${b.name}</strong> (Due: ${formattedDue})</span><span class="${paidClass}">${money(b.amt)}</span></div>`;
  });
  container.innerHTML=html;
  const totalPaidForMonth=billsForDisplay.filter(b=>b.isPaid).reduce((a,b)=>a+b.amt,0);
  const totalPlannedForMonth=billsForDisplay.reduce((a,b)=>a+b.amt,0);
  if(totalPaidForMonth===totalPlannedForMonth && totalPlannedForMonth>0){container.style.backgroundColor='#179d4d'; container.style.color='white';} 
  else{container.style.backgroundColor='#171923'; container.style.color='#e6e8f0';}
}

// --- Toggle ---
document.addEventListener('change', async e=>{
  if(e.target.matches('.toggle')){
    const id=e.target.dataset.id;
    state[id]=e.target.checked;
    console.log("Toggle changed:", id, state[id]);
    try{await setDoc(TOGGLE_DOC,{[id]:state[id]},{merge:true}); console.log("Saved to Firestore:", id);} 
    catch(err){ console.warn("Error saving:",err);}
    renderWeek();
  }
});

// --- Swipe & Pull ---
let touchStartX=0, touchStartY=0, touchEndX=0, touchEndY=0;
const SWIPE_THRESHOLD=50;
const weekContainer=document.getElementById('weekContainer');

weekContainer.addEventListener('touchstart', e=>{touchStartX=e.touches[0].screenX; touchStartY=e.touches[0].screenY;}, {passive:false});
weekContainer.addEventListener('touchmove', e=>{
  touchEndX=e.touches[0].screenX; touchEndY=e.touches[0].screenY;
  const deltaY=touchEndY-touchStartY;
  if(window.scrollY===0 && deltaY>0){e.preventDefault(); document.body.style.transform=`translateY(${deltaY}px)`;}
}, {passive:false});
weekContainer.addEventListener('touchend', e=>{
  const deltaX=touchEndX-touchStartX; const deltaY=touchEndY-touchStartY;
  if(Math.abs(deltaX)>Math.abs(deltaY)&&Math.abs(deltaX)>SWIPE_THRESHOLD){
    if(deltaX<0 && currentWeekIndex<WEEKS.length-1) currentWeekIndex++;
    if(deltaX>0 && currentWeekIndex>0) currentWeekIndex--;
    renderWeek();
  }
  document.body.style.transform='translateY(0)';
},{passive:false});

// --- Firebase auth ---
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, async user=>{
  if(user){
    console.log("User signed in:", user.uid);
    try{
      const snap=await getDoc(TOGGLE_DOC); 
      state=snap.exists()?snap.data():{};
      console.log("Loaded toggles:", state);
    }catch(e){ console.warn("Error reading Firestore:",e);}
    
    // Set current week to today
    const today=new Date();
    WEEKS.forEach((w,i)=>{
      const start=parseAZDate(w.date);
      const end=new Date(start.getTime()+6*24*60*60*1000);
      if(today>=start&&today<=end) currentWeekIndex=i;
    });
    renderWeek();
  }
});
</script>
