<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyC7ubmyUmeCAun50g-AUUOHiuwpGAys2HM",
  authDomain: "budget-tracker-1eea7.firebaseapp.com",
  projectId: "budget-tracker-1eea7",
  storageBucket: "budget-tracker-1eea7.appspot.com",
  messagingSenderId: "579597071031",
  appId: "1:579597071031:web:f30c2d42cc57268707d332"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const TOGGLE_DOC = doc(db, "toggles", "states");

// ====== Data ======
const WEEKS = [
  { date: '08/22/2025', income: 2017, items: [
    { id: 'kicks', name: 'Kicks', amount: 472, due: '10/01/2025' },
    { id: 'progressive', name: 'Progressive', amount: 300, due: '09/15/2025' },
    { id: 'rogue', name: 'Rogue', amount: 700, due: '09/03/2025' },
    { id: 'fridge', name: 'Fridge', amount: 60, due: '09/01/2025' },
    { id: 'penasco', name: 'Peñasco', amount: 45, due: '09/01/2025' },
    { id: 'vegas', name: 'Vegas', amount: 51, due: '09/01/2025' },
    { id: 'amazon', name: 'Amazon Prime', amount: 50, due: '09/08/2025' }
  ]},
  { date: '08/29/2025', income: 650, items: [
    { id: 'hawaiian', name: 'Hawaiian Airlines', amount: 65, due: '09/15/2025' },
    { id: 'city', name: 'City of Phoenix', amount: 60, due: '09/04/2025' },
    { id: 'chase', name: 'Chase', amount: 125, due: '09/15/2025' },
    { id: 'frontier', name: 'Frontier', amount: 65, due: '09/15/2025' }
  ]},
  { date: '09/05/2025', income: 2017, items: [
    { id: 'house', name: 'House payment', amount: 950, due: '10/01/2025' },
    { id: 'qs3064', name: 'Quicksilver 3064', amount: 100, due: '09/11/2025' },
    { id: 'centurylink', name: 'Century Link', amount: 70, due: '09/13/2025' },
    { id: 'tmobile', name: 'T-Mobile', amount: 368, due: '09/15/2025' },
    { id: 'hoa', name: 'HOA', amount: 160, due: '09/01/2025' }
  ]},
  { date: '09/12/2025', income: 650, items: [
    { id: 'walmart', name: 'Walmart', amount: 75, due: '09/17/2025' },
    { id: 'qs5989', name: 'Quicksilver 5989', amount: 100, due: '09/15/2025' },
    { id: 'capitalone', name: 'Capital One', amount: 189, due: '09/10/2025' }
  ]}
];
const ALL_BILLS_ORDER = [
  'city','qs3064','progressive','centurylink','tmobile','house','rogue','hoa','kicks','amazon','walmart','qs5989','capitalone','frontier','chase','hawaiian','fridge','penasco','vegas'
];

// ====== Helpers ======
function num(n){ return Number(n).toLocaleString(undefined,{maximumFractionDigits:0}); }
function money(n){ return `$${Number(n).toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:0})}`; }

async function initTracker() {
  // Load toggle state from Firestore
  let state = {};
  try {
    const snap = await getDoc(TOGGLE_DOC);
    state = snap.exists() ? snap.data() : {};
  } catch(e){ console.warn("Failed to load toggles:", e); }

  const weeksEl = document.getElementById('weeks');
  const allBillsEl = document.getElementById('allBills');

  function render() {
    weeksEl.innerHTML = '';
    WEEKS.forEach(week => {
      const card = document.createElement('section');
      card.className = 'card';
      const totalThisWeek = (week.items||[]).reduce((a,b)=>a+b.amount,0);
      const remaining = week.income - totalThisWeek;
      card.innerHTML = `<h2>${week.date} <span class="meta">· <span class="pill">Income $${num(week.income)}</span> <span class="pill good">Planned $${num(totalThisWeek)}</span></span></h2>
        <div class="row head"><div>Item</div><div class="due">Due</div><div class="amount">Amount</div><div>Paid</div></div>`;
      week.items.forEach(it=>{
        const row = document.createElement('div');
        row.className='row';
        row.innerHTML = `<div>${it.name}</div><div class="due">${it.due}</div><div class="amount">$${num(it.amount)}</div>
          <label><input type="checkbox" class="toggle" data-id="${it.id}" ${state[it.id]?'checked':''}></label>`;
        card.appendChild(row);
      });
      const totals = document.createElement('div');
      totals.className='totals';
      totals.innerHTML = `<div>Week total: <strong>$${num(totalThisWeek)}</strong></div>
        <div>Remaining from paycheck: <span class="${remaining>=0?'ok':'bad'}">$${num(remaining)}</span></div>`;
      card.appendChild(totals);
      weeksEl.appendChild(card);
    });

    // All Bills Table
    allBillsEl.innerHTML='';
    const byId = Object.fromEntries(WEEKS.flatMap(w=>w.items).map(it=>[it.id,it]));
    ALL_BILLS_ORDER.forEach(id=>{
      const it=byId[id];
      if(!it) return;
      const row = document.createElement('div');
      row.className='row';
      row.dataset.id=id;
      row.innerHTML = `<div>${it.name}</div><div class="due">${it.due}</div><div class="amount">$${num(it.amount)}</div>
        <div class="status muted">${state[id]?'Paid':'Unpaid'}</div>`;
      allBillsEl.appendChild(row);
    });
    recalcTotals();
  }

  function recalcTotals() {
    const byId = Object.fromEntries(WEEKS.flatMap(w=>w.items).map(it=>[it.id,it]));
    const planned = ALL_BILLS_ORDER.reduce((a,id)=> a + (byId[id]?.amount||0),0);
    const paid = ALL_BILLS_ORDER.reduce((a,id)=> a + (state[id] ? (byId[id]?.amount||0) : 0),0);
    const remaining = planned - paid;
    document.getElementById('plannedTotal').textContent=money(planned);
    document.getElementById('paidTotal').textContent=money(paid);
    document.getElementById('remainingTotal').textContent=money(remaining);
    const pct = planned ? Math.round((paid/planned)*100) : 0;
    document.getElementById('progressBar').style.width=pct+'%';

    document.querySelectorAll('#allBills .row').forEach(r=>{
      const id=r.dataset.id;
      const status=r.querySelector('.status');
      if(!id||!status) return;
      const paidNow = !!state[id];
      status.textContent = paidNow?'Paid':'Unpaid';
      status.style.color = paidNow?'var(--good)':'var(--text-dim)';
    });
  }

  // Handle toggle changes
  document.addEventListener('change', async e=>{
    if(e.target.matches('.toggle')){
      const id=e.target.dataset.id;
      state[id]=e.target.checked;
      try{
        // ✅ only update the one field, merge with existing
        await setDoc(TOGGLE_DOC, { [id]: state[id] }, { merge: true });
      } catch(err){
        console.warn("Failed to save toggle:", err);
      }
      recalcTotals();
    }
  });

  render();
}

initTracker();
</script>
