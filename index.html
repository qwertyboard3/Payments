<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ðŸ’° Budget Tracker</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #0f1115;
    color: #e6e8f0;
    margin: 20px;
  }
  h1, h2 { text-align:center; }
  .paydate, .overview {
    background: #171923;
    padding: 15px;
    margin: 15px 0;
    border-radius: 12px;
  }
  .bill {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
  }
  .progress {
    background:#242938;
    border-radius:6px;
    overflow:hidden;
    height:14px;
    margin-top:8px;
    border:1px solid #32384e;
  }
  .progress-bar {
    background: linear-gradient(90deg,#7c5cff,#22d06e);
    height:100%;
    width:0%;
    text-align:center;
    font-size:12px;
    color:#fff;
  }
  /* Toggle switch */
  .toggle {
    appearance: none;
    width: 50px;
    height: 26px;
    border-radius: 26px;
    position: relative;
    background: #252a36;
    border: 1px solid #394055;
    cursor: pointer;
    transition: .2s;
  }
  .toggle::after {
    content: "";
    position: absolute;
    top: 3px;
    left: 3px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #8a93a8;
    transition: .2s;
  }
  .toggle:checked {
    background: linear-gradient(90deg,#1db954,#22d06e);
    border-color: #179d4d;
  }
  .toggle:checked::after {
    left: 23px;
    background: white;
  }
  /* Bill label spacing */
  .bill span.amount { margin-right: 10px; }
</style>
</head>
<body>
<h1>ðŸ’° Budget Tracker</h1>
<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { initializeFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyC7ubmyUmeCAun50g-AUUOHiuwpGAys2HM",
  authDomain: "budget-tracker-1eea7.firebaseapp.com",
  projectId: "budget-tracker-1eea7",
  storageBucket: "budget-tracker-1eea7.firebasestorage.app",
  messagingSenderId: "579",
  appId: "1:579:web:demo"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = initializeFirestore(app, { localCache: undefined }); // disable cache

// Paydates (Arizona time) with due dates for bills
const paydates = [
  { date:"2025-08-22", income:2017, bills:[
    {name:"Kicks", amount:472, due:"2025-09-30"},
    {name:"Progressive", amount:300, due:"2025-09-15"},
    {name:"Rogue", amount:700, due:"2025-09-03"},
    {name:"Fridge", amount:60, due:"2025-09-01"},
    {name:"PeÃ±asco", amount:45, due:"2025-09-01"},
    {name:"Vegas", amount:51, due:"2025-09-01"},
    {name:"Amazon Prime", amount:50, due:"2025-09-08"}
  ]},
  { date:"2025-08-29", income:650, bills:[
    {name:"Hawaiian Air", amount:65, due:"2025-09-15"},
    {name:"City of Phoenix", amount:60, due:"2025-09-04"},
    {name:"Chase", amount:125, due:"2025-09-15"},
    {name:"Frontier", amount:65, due:"2025-09-15"}
  ]},
  { date:"2025-09-05", income:2017, bills:[
    {name:"House Payment", amount:950, due:"2025-09-30"},
    {name:"QS 3064", amount:100, due:"2025-09-11"},
    {name:"Century Link", amount:70, due:"2025-09-13"},
    {name:"T-Mobile", amount:368, due:"2025-09-15"},
    {name:"HOA", amount:160, due:"2025-09-01"}
  ]},
  { date:"2025-09-12", income:650, bills:[
    {name:"Walmart", amount:75, due:"2025-09-17"},
    {name:"Quicksilver 5989", amount:100, due:"2025-09-15"},
    {name:"Capital One", amount:189, due:"2025-09-10"}
  ]}
];

// Render function
function render(uid, toggles){
  const appDiv = document.getElementById("app");
  appDiv.innerHTML="";

  const billsByMonth = {}; // monthly aggregation by bill due date

  paydates.forEach((pd,index)=>{
    const div=document.createElement("div");
    div.className="paydate";

    let totalBills=pd.bills.reduce((s,b)=>s+b.amount,0);
    let remaining=pd.income-totalBills;

    div.innerHTML=`<h2>${new Date(pd.date+"T00:00:00-07:00").toLocaleDateString("en-US",{timeZone:"America/Phoenix"})} â€” $${pd.income}</h2>
      <div id="bills-${pd.date}"></div>
      <div class="progress"><div class="progress-bar" id="bar-${pd.date}">0%</div></div>
      <p><b>Total:</b> $${totalBills}</p>
      <p><b>Remaining:</b> $${remaining}</p>`;
    appDiv.appendChild(div);

    const billsDiv=div.querySelector(`#bills-${pd.date}`);
    pd.bills.forEach(b=>{
      const id=pd.date+"_"+b.name.replace(/\s+/g,"_");
      const checked=toggles[id]?.checked||false;
      billsDiv.innerHTML+=`<div class="bill">
        <span class="amount">$${b.amount}</span>
        <label><input type="checkbox" class="toggle" data-id="${id}" ${checked?"checked":""}/> ${b.name}</label>
      </div>`;

      // aggregate by due month
      const m = b.due.slice(0,7);
      if(!billsByMonth[m]) billsByMonth[m]={income:0,total:0,paid:0};
      billsByMonth[m].total+=b.amount;
      if(checked) billsByMonth[m].paid+=b.amount;
    });

    // Insert month overview after every 4 paydates starting in September
    if((index+1)%4===0){
      const keys = Object.keys(billsByMonth).filter(k=>k>="2025-09");
      keys.forEach(month=>{
        const mDiv=document.createElement("div");
        mDiv.className="overview";
        const vals=billsByMonth[month];
        mDiv.innerHTML=`<h2>${month} Overview</h2>
          <p><b>Total Bills:</b> $${vals.total}</p>
          <p><b>Paid:</b> $${vals.paid}</p>
          <p><b>Remaining:</b> $${vals.total-vals.paid}</p>`;
        appDiv.appendChild(mDiv);
      });
    }
  });

  // Update progress bars
  function updateBars(){
    paydates.forEach(pd=>{
      const bills=pd.bills.map(b=>pd.date+"_"+b.name.replace(/\s+/g,"_"));
      const checked=bills.filter(id=>document.querySelector(`[data-id="${id}"]`)?.checked).length;
      const pct=bills.length?Math.round((checked/bills.length)*100):0;
      const bar=document.getElementById("bar-"+pd.date);
      if(bar){ bar.style.width=pct+"%"; bar.textContent=pct+"%"; }
    });
  }
  updateBars();

  // Save toggle
  document.querySelectorAll("input.toggle").forEach(cb=>{
    cb.addEventListener("change", e=>{
      const id=e.target.dataset.id;
      setDoc(doc(db,"users",uid,"toggles",id), {checked:e.target.checked});
      updateBars();
      render(uid,toggles); // re-render to update monthly overview
    });
  });
}

// Auth + Firestore sync
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth,user=>{
  if(user){
    const uid=user.uid;
    onSnapshot(collection(db,"users",uid,"toggles"), snap=>{
      let toggles={};
      snap.forEach(d=>toggles[d.id]=d.data());
      render(uid,toggles);
    });
  }
});
</script>
</body>
</html>
