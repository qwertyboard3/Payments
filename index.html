<script type="module">
// ================== Firebase Setup ==================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Your Firebase config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

// Init
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ================== Data ==================
const WEEKS = [
  {
    date: "Aug 1–7",
    amount: 1200,
    bills: [
      { id: "rent", name: "Rent", amt: 600, due: "Aug 3" },
      { id: "wifi", name: "WiFi", amt: 60, due: "Aug 5" }
    ]
  },
  {
    date: "Aug 8–14",
    amount: 1100,
    bills: [
      { id: "car", name: "Car Payment", amt: 300, due: "Aug 10" }
    ]
  }
];

// Track current week & toggle states
let currentWeekIndex = 0;
let state = {};
let TOGGLE_DOC = null;

// ================== Render Functions ==================
function renderWeek() {
  const week = WEEKS[currentWeekIndex];
  const container = document.getElementById("weekView");

  if (!week) {
    container.innerHTML = "<p>No week data available.</p>";
    return;
  }

  container.innerHTML = `
    <h2>Week of ${week.date} – Income: $${week.amount}</h2>
    <ul>
      ${week.bills.map(b => `
        <li>
          <label>
            <input type="checkbox" data-id="${b.id}" ${state[b.id] ? "checked" : ""}>
            ${b.name} – $${b.amt} (due ${b.due})
          </label>
        </li>
      `).join("")}
    </ul>
  `;

  // Checkbox listeners
  container.querySelectorAll("input[type=checkbox]").forEach(cb => {
    cb.addEventListener("change", async e => {
      state[e.target.dataset.id] = e.target.checked;
      try {
        await setDoc(TOGGLE_DOC, state);
      } catch (err) {
        console.error("Error saving toggle:", err);
      }
    });
  });
}

function renderAllSummary() {
  const container = document.getElementById("allSummary");
  container.innerHTML = WEEKS.map(w =>
    `<p>${w.date}: Income $${w.amount}, Bills $${w.bills.reduce((t,b)=>t+b.amt,0)}</p>`
  ).join("");
}

function renderMonthSummary() {
  const container = document.getElementById("monthSummary");
  const totalIncome = WEEKS.reduce((t,w)=>t+w.amount,0);
  const totalBills  = WEEKS.reduce((t,w)=>t+w.bills.reduce((s,b)=>s+b.amt,0),0);
  container.innerHTML = `<p>Total Income: $${totalIncome} | Total Bills: $${totalBills}</p>`;
}

// ================== Auth & Firestore ==================
onAuthStateChanged(auth, async user => {
  if (!user) {
    await signInAnonymously(auth);
    return;
  }

  console.log("Signed in:", user.uid);
  TOGGLE_DOC = doc(db, "users", user.uid, "data", "toggles");

  // Load saved state
  const snap = await getDoc(TOGGLE_DOC);
  if (snap.exists()) {
    state = snap.data();
  }

  // Render everything
  renderWeek();
  renderAllSummary();
  renderMonthSummary();
});
</script>
